<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Web Flores Timur</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <style>
        /* Make sure html and body take up full height */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        /* Use flexbox to layout the navbar and map */
        body {
            display: flex;
            flex-direction: column;
        }
        /* The map will grow to fill available space */
        #map {
            flex-grow: 1;
            width: 100%;
        }
        
        /* Custom styles for Layer Control with inline legends */
        .leaflet-control-layers-overlays label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .legend-in-control {
            padding-left: 25px; /* Indent legend under the checkbox */
            font-size: 12px;
            line-height: 1.6;
            margin-top: 6px;
            color: #555;
        }
        .legend-in-control i {
            width: 18px;
            height: 14px;
            float: left;
            margin-right: 6px;
            opacity: 0.9;
        }
        .legend-in-control span {
            display: inline-block;
            width: 22px;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* Search Autocomplete Styles */
        .search-container {
            position: relative;
        }
        #searchResults {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000; /* Ensure it's above map but below modal */
            max-height: 300px;
            overflow-y: auto;
        }

    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Peta Flores Timur</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">Tentang</a>
                    </li>
                </ul>
                <div class="search-container">
                    <form class="d-flex" role="search" id="searchForm">
                        <input class="form-control me-2" type="search" id="searchInput" placeholder="Cari Kecamatan..." autocomplete="off">
                        <button class="btn btn-outline-light" type="submit">Cari</button>
                    </form>
                    <div id="searchResults" class="list-group"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Feature Modal -->
    <div class="modal fade" id="featureModal" tabindex="-1" aria-labelledby="featureModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="featureModalLabel">Detail Informasi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center" id="modalBodyContent">
                    <!-- Konten akan diisi oleh JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">Tentang Peta Ini</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Peta Web Interaktif Kabupaten Flores Timur ini dibuat sebagai bagian dari praktikum.</p>
                    <p>Teknologi yang digunakan:</p>
                    <ul>
                        <li>LeafletJS</li>
                        <li>Bootstrap 5</li>
                    </ul>
                    <hr>
                    <p><strong>Sumber Data:</strong></p>
                    <ul>
                        <li>Batas Administrasi & Fitur Peta: GeoJSON</li>
                        <li>Basemap: OpenStreetMap & Esri Satelit</li>
                    </ul>
                    <hr>
                    <p><strong>Nama: Raka Derama Meikal</strong></p>
                    <p><strong>NIM: 24/533597/SV/23921</strong></p>
                    <p><strong>Kelas: PGWEB-B</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // 1. Inisialisasi Peta
        var map = L.map('map').setView([-8.3446, 122.9812], 11); // Koordinat tengah Flores Timur

        // Inisialisasi Modal Bootstrap
        var featureModal = new bootstrap.Modal(document.getElementById('featureModal'));

        // 2. Menambahkan Basemap (Peta Dasar)
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        var esriSatelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // Set basemap default
        osm.addTo(map);

        var baseMaps = {
            "OpenStreetMap": osm,
            "Esri Satelit": esriSatelit
        };

        // 3. Menambahkan Data GeoJSON sebagai Overlay
        var overlayMaps = {};
        var batasKecamatanLayer; // Variabel untuk menyimpan layer kecamatan

        // Fungsi untuk menampilkan modal
        function showKecamatanModal(layer) {
            if (layer.feature.properties && layer.feature.properties.WADMKC) {
                document.getElementById('featureModalLabel').innerText = layer.feature.properties.WADMKC;
                document.getElementById('modalBodyContent').innerHTML = '<h3><i class="bi bi-people-fill"></i> ' + layer.feature.properties.Penduduk.toLocaleString("id-ID") + '</h3>';
                featureModal.show();
            }
        }

        // Fungsi untuk memberi warna acak pada poligon
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Style untuk Sungai
        var sungaiStyle = {
            "color": "#0000ff",
            "weight": 3,
            "opacity": 0.7
        };

        // --- SIMBOLOGI JALAN ---
        function styleJalan(feature) {
            switch (feature.properties.NAMA_UNSUR) {
                case 'Jalan Propinsi': return { color: '#a50026', weight: 4 };
                case 'Jalan Kabupaten': return { color: '#f46d43', weight: 2.5 };
                case 'Jalan Lain': return { color: '#fee090', weight: 1.5 };
                default: return { color: '#cccccc', weight: 1 };
            }
        }

        // --- SIMBOLOGI GRADUATED UNTUK KECAMATAN ---
        function getColorBatasKecamatan(d) {
            return d > 30000 ? '#8B4513' : // SaddleBrown (> 30000)
                   d > 15000 ? '#A0522D' : // Sienna (15000 - 30000)
                               '#D2B48C';   // Tan (< 15000)
        }

        // Fungsi style untuk layer kecamatan
        function styleBatasKecamatan(feature) {
            return {
                fillColor: getColorBatasKecamatan(feature.properties.Penduduk),
                weight: 1.5,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.8
            };
        }

        // Memuat Batas Desa
        fetch('data/batas_desa.geojson')
            .then(response => response.json())
            .then(data => {
                var batasDesaLayer = L.geoJSON(data, {
                    style: function(feature) {
                        return { color: getRandomColor(), weight: 1, opacity: 0.7 };
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.NAMOBJ) {
                            layer.bindPopup('Desa: ' + feature.properties.NAMOBJ);
                        }
                    }
                });
                overlayMaps["Batas Desa"] = batasDesaLayer;
                addControlLayer();
            });

        // Memuat Batas Kecamatan dengan style graduated
        fetch('data/batas_kecamatan.geojson')
            .then(response => response.json())
            .then(data => {
                batasKecamatanLayer = L.geoJSON(data, {
                    style: styleBatasKecamatan, // Menggunakan fungsi style graduated
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.WADMKC) {
                            layer.bindTooltip(feature.properties.WADMKC, { sticky: true, permanent: false });
                            L.DomEvent.disableClickPropagation(layer);
                            layer.on('click', function (e) {
                                showKecamatanModal(e.target);
                            });
                        }
                    }
                });
                
                var popLegendHtml = '<div class="legend-in-control">' +
                    '<div><i style="background:#D2B48C"></i> &lt; 15.000</div>' +
                    '<div><i style="background:#A0522D"></i> 15.000 &ndash; 30.000</div>' +
                    '<div><i style="background:#8B4513"></i> &gt; 30.000</div>' +
                    '</div>';
                overlayMaps['Batas Kecamatan' + popLegendHtml] = batasKecamatanLayer;

                batasKecamatanLayer.addTo(map); // Langsung tampilkan
                addControlLayer();
            });

        // Memuat Jalan
        fetch('data/jalan.geojson')
            .then(response => response.json())
            .then(data => {
                var jalanLayer = L.geoJSON(data, { style: styleJalan });

                var roadLegendHtml = '<div class="legend-in-control">' +
                    '<div><span style="border-bottom: 4px solid #a50026;"></span>Jalan Propinsi</div>' +
                    '<div><span style="border-bottom: 2.5px solid #f46d43;"></span>Jalan Kabupaten</div>' +
                    '<div><span style="border-bottom: 1.5px solid #fee090;"></span>Jalan Lain</div>' +
                    '</div>';
                overlayMaps['Jalan' + roadLegendHtml] = jalanLayer;

                addControlLayer();
            });

        // Memuat Sungai
        fetch('data/sungai.geojson')
            .then(response => response.json())
            .then(data => {
                var sungaiLayer = L.geoJSON(data, { style: sungaiStyle });
                var sungaiLegendHtml = '<div class="legend-in-control">' +
                    '<div><span style="border-bottom: 3px solid #0000ff;"></span>Sungai</div>' +
                    '</div>';
                overlayMaps['Sungai' + sungaiLegendHtml] = sungaiLayer;
                addControlLayer();
            });

        // Memuat Toponimi (Points of Interest)
        fetch('data/toponimi.geojson')
            .then(response => response.json())
            .then(data => {
                var toponimiLayer = L.geoJSON(data, {
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.NAMOBJ) {
                            layer.bindPopup(feature.properties.NAMOBJ);
                        }
                    }
                });
                overlayMaps["Toponimi"] = toponimiLayer;
                addControlLayer();
            });

        // 4. Menambahkan Kontrol Layer
        var controlLayer;
        function addControlLayer() {
            if (controlLayer) {
                map.removeControl(controlLayer);
            }
            controlLayer = L.control.layers(baseMaps, overlayMaps).addTo(map);
        }
        addControlLayer(); // Panggil pertama kali

        // 5. Logika Pencarian
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const searchForm = document.getElementById('searchForm');

        // Mencegah form submit standar
        searchForm.addEventListener('submit', e => e.preventDefault());

        // Listener untuk input pencarian
        searchInput.addEventListener('input', function () {
            const query = this.value.trim().toLowerCase();
            searchResults.innerHTML = '';

            if (query.length < 2) {
                return; // Hanya cari jika query cukup panjang
            }

            if (batasKecamatanLayer) {
                batasKecamatanLayer.eachLayer(function (layer) {
                    const kecamatanName = layer.feature.properties.WADMKC.toLowerCase();
                    if (kecamatanName.includes(query)) {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerText = layer.feature.properties.WADMKC;
                        
                        item.addEventListener('click', function (e) {
                            e.preventDefault();
                            map.fitBounds(layer.getBounds());
                            showKecamatanModal(layer);
                            searchInput.value = ''; // Kosongkan input
                            searchResults.innerHTML = ''; // Kosongkan hasil
                        });

                        searchResults.appendChild(item);
                    }
                });
            }
        });

        // Sembunyikan hasil jika klik di luar
        map.on('click', function() {
            searchResults.innerHTML = '';
        });

    </script>
</body>
</html>
